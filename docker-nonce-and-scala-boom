# statistics , nonce and tomcat embedded
#

# Takipi
#
# Installs and runs Takipi with a Java tester

# Start with a working oracle jdk 7 image
FROM java:7

MAINTAINER Chen Harel "https://github.com/chook"

# Getting Java testers
RUN apt-get update
RUN apt-get install -y git

# Getting testers and run_testers bash from github
RUN cd /opt ; git clone https://github.com/hodayagamliel/statistics-tester-java.git
RUN cd /opt ; wget https://s3.amazonaws.com/app-takipi-com/chen/scala-boom.jar -O scala-boom.jar
# RUN cd /opt ; git clone https://github.com/hodayagamliel/docker_hodaya.git

# Installing Takipi via apt-get and setting up key
RUN echo "deb [arch=amd64] http://takipi-deb-repo.s3.amazonaws.com stable main" > /etc/apt/sources.list.d/takipi.list
ENV DEBIAN_FRONTEND noninteractive
RUN wget -O - http://takipi-deb-repo.s3.amazonaws.com/hello@takipi.com.gpg.key | apt-key add -
RUN apt-get update
RUN apt-get install takipi

# Overriding binaries with the Heroku version of Takipi
RUN wget https://s3.amazonaws.com/app-takipi-com/deploy/linux/takipi-latest-heroku.tar.gz -O takipi-heroku.tar.gz
RUN tar zxvf takipi-heroku.tar.gz
#RUN mv .takipi takipi
RUN cp -r takipi /opt

ENV PATH $PATH:/opt/takipi/bin
ENV TAKIPI_SERVICE_PARAMS --xmx=180M
ENV TAKIPI_HEAP_SIZE 200m


RUN /opt/takipi/etc/takipi-setup-secret-key S13136#hQQtJMeUoKi4C/P/#NeahtjCVpNVHo5AaZWkYezWKlxiHD8JShqYWvmqpwdU=#66cc

# Set server name
RUN /opt/takipi/etc/takipi-setup-machine-name takipi-testers-docker

# Running run_testers bash who run Java-statistics and Scala-boom with Takipi agent

CMD  (nohup /opt/statistics-tester-java/java_nonce_create.sh 2 1000 &) && \
	(java -agentlib:TakipiAgent -jar /opt/scala-boom.jar)
